// Prisma schema for job matching audit system
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Job upsert audit trail
model AuditJobUpsert {
  id        Int      @id @default(autoincrement())
  jobId     String   @map("job_id")
  requestId String?  @map("request_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Input
  title    String?
  rawInput Json?    @map("raw_input")

  // Capsules
  domainCapsule  String?  @map("domain_capsule")
  domainKeywords String[] @map("domain_keywords")
  taskCapsule    String?  @map("task_capsule")
  taskKeywords   String[] @map("task_keywords")

  // Classification
  jobClass                 String?  @map("job_class")
  classificationConfidence Float?   @map("classification_confidence")
  credentials              String[] @map("credentials")
  subjectMatterCodes       String[] @map("subject_matter_codes")
  expertiseTier            String?  @map("expertise_tier")
  classificationReasoning  String?  @map("classification_reasoning")

  // Metrics
  elapsedMs Int? @map("elapsed_ms")

  @@map("audit_job_upserts")
  @@index([jobId])
  @@index([createdAt])
}

// User upsert audit trail
model AuditUserUpsert {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  requestId String?  @map("request_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Raw input from Bubble
  rawInput Json? @map("raw_input")

  // Input summary
  resumeChars          Int?     @map("resume_chars")
  hasWorkExperience    Boolean? @map("has_work_experience")
  hasEducation         Boolean? @map("has_education")
  hasLabelingExperience Boolean? @map("has_labeling_experience")
  country              String?
  languages            String[]

  // Capsules
  domainCapsule        String?  @map("domain_capsule")
  taskCapsule          String?  @map("task_capsule")
  evidenceDetected     Boolean? @map("evidence_detected")
  validationViolations String[] @map("validation_violations")

  // Classification
  expertiseTier            String?  @map("expertise_tier")
  credentials              String[] @default([])
  subjectMatterCodes       String[] @map("subject_matter_codes") @default([])
  yearsExperience          Int?     @map("years_experience")
  classificationConfidence Float?   @map("classification_confidence")

  // Metrics
  elapsedMs Int? @map("elapsed_ms")

  @@map("audit_user_upserts")
  @@index([userId])
  @@index([createdAt])
}

// Match request audit
model AuditMatchRequest {
  id        Int      @id @default(autoincrement())
  jobId     String   @map("job_id")
  requestId String?  @map("request_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Request params
  candidateCount Int?    @map("candidate_count")
  wDomain        Float?  @map("w_domain")
  wTask          Float?  @map("w_task")
  weightsSource  String? @map("weights_source")
  thresholdUsed  Float?  @map("threshold_used")
  topKUsed       Int?    @map("top_k_used")

  // Results summary
  resultsReturned      Int? @map("results_returned")
  countGteThreshold    Int? @map("count_gte_threshold")
  missingDomainVectors Int? @map("missing_domain_vectors")
  missingTaskVectors   Int? @map("missing_task_vectors")

  // Metrics
  elapsedMs Int? @map("elapsed_ms")

  // Relations
  results AuditMatchResult[]

  @@map("audit_match_requests")
  @@index([jobId])
  @@index([createdAt])
}

// Individual match scores
model AuditMatchResult {
  id             Int    @id @default(autoincrement())
  matchRequestId Int    @map("match_request_id")
  userId         String @map("user_id")

  sDomain    Float? @map("s_domain")
  sTask      Float? @map("s_task")
  finalScore Float? @map("final_score")
  rank       Int?

  // Relations
  matchRequest AuditMatchRequest @relation(fields: [matchRequestId], references: [id], onDelete: Cascade)

  @@map("audit_match_results")
  @@index([matchRequestId])
  @@index([userId])
}

// Ground truth for evaluation (future)
model EvaluationGroundTruth {
  id        Int      @id @default(autoincrement())
  jobId     String   @map("job_id")
  userId    String   @map("user_id")
  outcome   String   // 'hired', 'rejected', 'not_a_fit'
  createdAt DateTime @default(now()) @map("created_at")
  source    String?  // 'bubble_sync', 'manual'

  @@map("evaluation_ground_truth")
  @@unique([jobId, userId])
  @@index([jobId])
  @@index([userId])
}

// User match request audit (score_jobs_for_user)
model AuditUserMatchRequest {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  requestId String?  @map("request_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Request params
  jobCount      Int?    @map("job_count")
  weightsSource String? @map("weights_source")
  thresholdUsed Float?  @map("threshold_used")
  topKUsed      Int?    @map("top_k_used")

  // Results summary
  resultsReturned      Int? @map("results_returned")
  countGteThreshold    Int? @map("count_gte_threshold")
  missingDomainVectors Int? @map("missing_domain_vectors")
  missingTaskVectors   Int? @map("missing_task_vectors")

  // User context (for display)
  userExpertiseTier String? @map("user_expertise_tier")

  // Threshold info
  suggestedThreshold       Float?  @map("suggested_threshold")
  suggestedThresholdMethod String? @map("suggested_threshold_method")

  // Metrics
  elapsedMs Int? @map("elapsed_ms")

  // Relations
  results AuditUserMatchResult[]

  @@map("audit_user_match_requests")
  @@index([userId])
  @@index([createdAt])
}

// Individual job scores for user match
model AuditUserMatchResult {
  id             Int    @id @default(autoincrement())
  matchRequestId Int    @map("match_request_id")
  jobId          String @map("job_id")

  jobClass       String?  @map("job_class")
  wDomain        Float?   @map("w_domain")
  wTask          Float?   @map("w_task")
  sDomain        Float?   @map("s_domain")
  sTask          Float?   @map("s_task")
  finalScore     Float    @map("final_score")
  rank           Int
  jobThreshold   Float?   @map("job_threshold")
  aboveThreshold Boolean? @map("above_threshold")

  // Relations
  matchRequest AuditUserMatchRequest @relation(fields: [matchRequestId], references: [id], onDelete: Cascade)

  @@map("audit_user_match_results")
  @@index([matchRequestId])
  @@index([jobId])
}

// Job notification audit trail
model AuditJobNotify {
  id                  Int      @id @default(autoincrement())
  jobId               String   @map("job_id")
  requestId           String   @map("request_id")
  createdAt           DateTime @default(now()) @map("created_at")

  // Job info
  title               String?
  jobClass            String?  @map("job_class")

  // Filters used
  countriesFilter     String[] @map("countries_filter")
  languagesFilter     String[] @map("languages_filter")
  maxNotifications    Int      @map("max_notifications")

  // Results summary
  totalCandidates     Int      @map("total_candidates")
  totalAboveThreshold Int      @map("total_above_threshold")
  notifyCount         Int      @map("notify_count")

  // Threshold info
  thresholdSpecialized Float   @map("threshold_specialized")
  thresholdGeneric     Float   @map("threshold_generic")

  // Score stats
  scoreMin            Float?   @map("score_min")
  scoreMax            Float?   @map("score_max")

  // Performance
  elapsedMs           Int?     @map("elapsed_ms")

  // Relations
  results             AuditJobNotifyResult[]

  @@map("audit_job_notify")
  @@index([jobId])
  @@index([createdAt])
}

// Individual user results for job notifications
model AuditJobNotifyResult {
  id              Int            @id @default(autoincrement())
  notifyRequestId Int            @map("notify_request_id")
  notifyRequest   AuditJobNotify @relation(fields: [notifyRequestId], references: [id], onDelete: Cascade)

  userId          String         @map("user_id")

  // User context
  userCountry     String?        @map("user_country")
  userLanguages   String[]       @map("user_languages")
  expertiseTier   String?        @map("expertise_tier")

  // Scores
  domainScore     Float          @map("domain_score")
  taskScore       Float          @map("task_score")
  finalScore      Float          @map("final_score")
  thresholdUsed   Float          @map("threshold_used")

  // Outcome
  notified        Boolean
  filterReason    String?        @map("filter_reason")
  rank            Int?

  @@map("audit_job_notify_results")
  @@index([notifyRequestId])
  @@index([userId])
}
